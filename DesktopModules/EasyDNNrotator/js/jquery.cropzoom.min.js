(function(c){c.fn.cropzoom=function(f){return this.each(function(){function h(a){0<a.position.top&&(b("image").posY=0);0<a.position.left&&(b("image").posX=0);var g=-(b("image").h-a.helper.parent().parent().height()),c=-(b("image").w-a.helper.parent().parent().width());a.position.top<g&&(b("image").posY=g);a.position.left<c&&(b("image").posX=c);l()}function p(){b("image").scaleX=a.width/b("image").w;b("image").scaleY=a.height/b("image").h}function l(){c(function(){var a=b("image").rotation*Math.PI/
180,d=Math.sin(a),n=Math.cos(a),k=n*b("image").w;a=d*b("image").w;var e=-d*b("image").h,h=n*b("image").h,f=n*b("image").w-d*b("image").h;n=d*b("image").w+n*b("image").h;d=Math.min(0,k,e,f);k=Math.max(0,k,e,f);e=Math.min(0,a,h,n);a=Math.max(0,a,h,n);b("image").rotW=k-d;b("image").rotH=a-e;b("image").rotY=e;b("image").rotX=d;rotation="rotate("+b("image").rotation+"deg)";c(q).css({transform:rotation,"-webkit-transform":rotation,"-ms-transform":rotation,msTransform:rotation,top:b("image").posY,left:b("image").posX})})}
function e(){var g=c("<div />").attr("id","rotationContainer").mouseover(function(){c(this).css("opacity",1)}).mouseout(function(){c(this).css("opacity",.6)}),d=c("<div />").attr("id","rotationMin").html("0"),n=c("<div />").attr("id","rotationMax").html("360"),e=c("<div />").attr("id","rotationSlider"),h="vertical",f=Math.abs(360-a.image.rotation);"horizontal"==a.expose.slidersOrientation&&(h="horizontal",f=a.image.rotation);e.slider({orientation:h,value:f,range:"max",min:0,max:360,step:360<a.rotationSteps||
0>a.rotationSteps?1:a.rotationSteps,slide:function(c,g){b("image").rotation=360==f?Math.abs(360-g.value):Math.abs(g.value);l();if(null!=a.image.onRotate)a.image.onRotate(e,b("image").rotation)}});g.append(d);g.append(e);g.append(n);""!=a.expose.rotationElement?(e.addClass(a.expose.slidersOrientation),g.addClass(a.expose.slidersOrientation),d.addClass(a.expose.slidersOrientation),n.addClass(a.expose.slidersOrientation),c(a.expose.rotationElement).empty().append(g)):(e.addClass("vertical"),g.addClass("vertical"),
d.addClass("vertical"),n.addClass("vertical"),g.css({position:"absolute",top:5,left:5,opacity:.6}),k.append(g))}function r(){var g=c("<div />").attr("id","zoomContainer").mouseover(function(){c(this).css("opacity",1)}).mouseout(function(){c(this).css("opacity",.6)}),d=c("<div />").attr("id","zoomMin").html("<b>-</b>"),e=c("<div />").attr("id","zoomMax").html("<b>+</b>"),f=c("<div />").attr("id","zoomSlider");f.slider({orientation:""!=a.expose.zoomElement?a.expose.slidersOrientation:"vertical",value:0!=
a.image.startZoom?a.image.startZoom:t(b("image")),min:a.image.useStartZoomAsMinZoom?a.image.startZoom:a.image.minZoom,max:a.image.maxZoom,step:a.zoomSteps>a.image.maxZoom||0>a.zoomSteps?1:a.zoomSteps,slide:function(g,d){var e="vertical"==a.expose.slidersOrientation?a.image.maxZoom-d.value:d.value,f=a.image.width*Math.abs(e)/100;e=a.image.height*Math.abs(e)/100;c(q).css({width:f+"px",height:e+"px"});var k=b("image").w/2-f/2,h=b("image").h/2-e/2;k=0<k?b("image").posX+Math.abs(k):b("image").posX-Math.abs(k);
h=0<h?b("image").posY+Math.abs(h):b("image").posY-Math.abs(h);b("image").posX=k;b("image").posY=h;b("image").w=f;b("image").h=e;p();l();if(null!=a.image.onZoom)a.image.onZoom(q,b("image"))}});"vertical"==a.slidersOrientation?(g.append(e),g.append(f),g.append(d)):(g.append(d),g.append(f),g.append(e));""!=a.expose.zoomElement?(d.addClass(a.expose.slidersOrientation),e.addClass(a.expose.slidersOrientation),f.addClass(a.expose.slidersOrientation),g.addClass(a.expose.slidersOrientation),c(a.expose.zoomElement).empty().append(g)):
(d.addClass("vertical"),e.addClass("vertical"),f.addClass("vertical"),g.addClass("vertical"),g.css({position:"absolute",top:5,right:5,opacity:.6}),k.append(g))}function t(){return b("image").w>b("image").h?a.image.maxZoom-100*b("image").w/a.image.width:a.image.maxZoom-100*b("image").h/a.image.height}function w(){var g=!1;var d=0<m.find("#infoSelector").length?m.find("#infoSelector"):c("<div />").attr("id","infoSelector").css({position:"absolute",top:0,left:0,background:a.selector.bgInfoLayer,opacity:.6,
"font-size":a.selector.infoFontSize+"px","font-family":"Arial",color:a.selector.infoFontColor,width:"100%"});a.selector.showPositionsOnDrag&&(d.html("X:"+Math.round(b("selector").x)+"px - Y:"+Math.round(b("selector").y)+"px"),g=!0);a.selector.showDimetionsOnDrag&&(g?d.html(d.html()+" | W:"+b("selector").w+"px - H:"+b("selector").h+"px"):d.html("W:"+b("selector").w+"px - H:"+b("selector").h+"px"));m.append(d)}function u(b){k.find("#t").css({display:"block",width:a.width,height:b.position.top,left:0,
top:0});k.find("#b").css({display:"block",width:a.width,height:a.height,top:b.position.top+m.height()+"px",left:0});k.find("#l").css({display:"block",left:0,top:b.position.top,width:b.position.left,height:m.height()});k.find("#r").css({display:"block",top:b.position.top,left:b.position.left+m.width()+"px",width:a.width,height:m.height()+"px"})}function z(){k.find("#t").hide();k.find("#b").hide();k.find("#l").hide();k.find("#r").hide()}function x(a,b){k.data(a,b)}function b(a){return k.data(a)}function B(){var b=
c("<table><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></table>"),d=[];d.push(c("<div />").addClass("mvn_no mvn"));d.push(c("<div />").addClass("mvn_n mvn"));d.push(c("<div />").addClass("mvn_ne mvn"));d.push(c("<div />").addClass("mvn_o mvn"));d.push(c("<div />").addClass("mvn_c"));d.push(c("<div />").addClass("mvn_e mvn"));d.push(c("<div />").addClass("mvn_so mvn"));d.push(c("<div />").addClass("mvn_s mvn"));d.push(c("<div />").addClass("mvn_se mvn"));
for(var e=0;e<d.length;e++)d[e].mousedown(function(){A(this)}).mouseup(function(){clearTimeout(y)}).mouseout(function(){clearTimeout(y)}),b.find("td:eq("+e+")").append(d[e]);c(a.expose.elementMovement).empty().append(b)}function A(g){c(g).hasClass("mvn_no")?(b("image").posX=b("image").posX-a.expose.movementSteps,b("image").posY=b("image").posY-a.expose.movementSteps):c(g).hasClass("mvn_n")?b("image").posY=b("image").posY-a.expose.movementSteps:c(g).hasClass("mvn_ne")?(b("image").posX=b("image").posX+
a.expose.movementSteps,b("image").posY=b("image").posY-a.expose.movementSteps):c(g).hasClass("mvn_o")?b("image").posX=b("image").posX-a.expose.movementSteps:c(g).hasClass("mvn_c")?(b("image").posX=a.width/2-b("image").w/2,b("image").posY=a.height/2-b("image").h/2):c(g).hasClass("mvn_e")?b("image").posX=b("image").posX+a.expose.movementSteps:c(g).hasClass("mvn_so")?(b("image").posX=b("image").posX-a.expose.movementSteps,b("image").posY=b("image").posY+a.expose.movementSteps):c(g).hasClass("mvn_s")?
b("image").posY=b("image").posY+a.expose.movementSteps:c(g).hasClass("mvn_se")&&(b("image").posX=b("image").posX+a.expose.movementSteps,b("image").posY=b("image").posY+a.expose.movementSteps);if(a.image.snapToContainer){0<b("image").posY&&(b("image").posY=0);0<b("image").posX&&(b("image").posX=0);var d=-(b("image").h-k.height()),e=-(b("image").w-k.width());b("image").posY<d&&(b("image").posY=d);b("image").posX<e&&(b("image").posX=e)}l();y=setTimeout(function(){A(g)},100)}var k=null,y=null,m=null,
q=null,a=c.extend(!0,{width:500,height:375,bgColor:"#000",overlayColor:"#000",selector:{x:0,y:0,w:229,h:100,aspectRatio:!1,centered:!1,borderColor:"yellow",borderColorHover:"red",bgInfoLayer:"#FFF",infoFontSize:10,infoFontColor:"blue",showPositionsOnDrag:!0,showDimetionsOnDrag:!0,maxHeight:null,maxWidth:null,startWithOverlay:!1,hideOverlayOnDragAndResize:!0,onSelectorDrag:null,onSelectorDragStop:null,onSelectorResize:null,onSelectorResizeStop:null},image:{source:"",rotation:0,width:0,height:0,minZoom:10,
maxZoom:150,startZoom:0,x:0,y:0,useStartZoomAsMinZoom:!1,snapToContainer:!1,onZoom:null,onRotate:null,onImageDrag:null},enableRotation:!0,enableZoom:!0,zoomSteps:1,rotationSteps:5,expose:{slidersOrientation:"vertical",zoomElement:"",rotationElement:"",elementMovement:"",movementSteps:5}},f);if(c.isFunction(c.fn.draggable)&&c.isFunction(c.fn.resizable)&&c.isFunction(c.fn.slider))if(""==a.image.source||0==a.image.width||0==a.image.height)alert("You must set the source, witdth and height of the image element");
else{k=c(this);x("options",a);k.empty();k.css({width:a.width,height:a.height,"background-color":a.bgColor,overflow:"hidden",position:"relative",border:"2px solid #333"});x("image",{h:a.image.height,w:a.image.width,posY:a.image.y,posX:a.image.x,scaleX:0,scaleY:0,rotation:a.image.rotation,source:a.image.source,bounds:[0,0,0,0],id:"image_to_crop_"+k[0].id});p();(function(){if(0!=a.image.startZoom){var c=a.image.width*Math.abs(a.image.startZoom)/100,d=a.image.height*Math.abs(a.image.startZoom)/100;b("image").h=
d;b("image").w=c;0!=b("image").posY&&0!=b("image").posX&&(b("image").h>a.height?b("image").posY=Math.abs(a.height/2-b("image").h/2):b("image").posY=a.height/2-b("image").h/2,b("image").w>a.width?b("image").posX=Math.abs(a.width/2-b("image").w/2):b("image").posX=a.width/2-b("image").w/2)}else c=b("image").scaleX,d=b("image").scaleY,d<c?(b("image").h=a.height,b("image").w=Math.round(b("image").w*d)):(b("image").h=Math.round(b("image").h*c),b("image").w=a.width);b("image").w<a.width&&b("image").h<a.height&&
(a.image.snapToContainer=!1);l()})();x("selector",{x:a.selector.x,y:a.selector.y,w:null!=a.selector.maxWidth?a.selector.w>a.selector.maxWidth?a.selector.maxWidth:a.selector.w:a.selector.w,h:null!=a.selector.maxHeight?a.selector.h>a.selector.maxHeight?a.selector.maxHeight:a.selector.h:a.selector.h});$container=c("<div />").attr("id","k").css({width:a.width,height:a.height,position:"absolute"});q=c("<img />");q.attr("src",a.image.source);c(q).css({position:"absolute",left:b("image").posX,top:b("image").posY,
width:b("image").w,height:b("image").h});var v=function(){var b=a.image.source.split(".");return b[b.length-1]}();"png"!=v&&"gif"!=v||c(q).css("filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a.image.source+"',sizingMethod='scale');");$container.append(q);k.append($container);l();c(q).draggable({refreshPositions:!0,drag:function(c,d){b("image").posY=d.position.top;b("image").posX=d.position.left;a.image.snapToContainer?h(d):l();if(null!=a.image.onImageDrag)a.image.onImageDrag(q)},
stop:function(b,c){a.image.snapToContainer&&h(c)}});(function(){a.selector.centered&&(b("selector").y=a.height/2-b("selector").h/2,b("selector").x=a.width/2-b("selector").w/2);m=c("<div/>").attr("id",k[0].id+"_selector").css({width:b("selector").w,height:b("selector").h,top:b("selector").y+"px",left:b("selector").x+"px",border:"1px dashed "+a.selector.borderColor,position:"absolute",cursor:"move"}).mouseover(function(){c(this).css({border:"1px dashed "+a.selector.borderColorHover})}).mouseout(function(){c(this).css({border:"1px dashed "+
a.selector.borderColor})});m.draggable({containment:"parent",iframeFix:!0,refreshPositions:!0,drag:function(c,d){b("selector").x=d.position.left;b("selector").y=d.position.top;u(d);w();if(null!=a.selector.onSelectorDrag)a.selector.onSelectorDrag(m,b("selector"))},stop:function(c,d){a.selector.hideOverlayOnDragAndResize&&z();if(null!=a.selector.onSelectorDragStop)a.selector.onSelectorDragStop(m,b("selector"))}});m.resizable({aspectRatio:a.selector.aspectRatio,maxHeight:a.selector.maxHeight,maxWidth:a.selector.maxWidth,
minHeight:a.selector.h,minWidth:a.selector.w,containment:"parent",resize:function(c,d){b("selector").w=m.width();b("selector").h=m.height();u(d);w();if(null!=a.selector.onSelectorResize)a.selector.onSelectorResize(m,b("selector"))},stop:function(c,d){a.selector.hideOverlayOnDragAndResize&&z();if(null!=a.selector.onSelectorResizeStop)a.selector.onSelectorResizeStop(m,b("selector"))}});w(m);k.append(m)})();k.find(".ui-icon-gripsmall-diagonal-se").css({background:"#FFF",border:"1px solid #000",width:8,
height:8});(function(){c.each(["t","b","l","r"],function(){var b=c("<div />").attr("id",this).css({overflow:"hidden",background:a.overlayColor,opacity:.6,position:"absolute","z-index":2,visibility:"visible"});k.append(b)})})();a.selector.startWithOverlay&&(v={position:{top:m.position().top,left:m.position().left}},u(v));a.enableZoom&&r();a.enableRotation&&e();""!=a.expose.elementMovement&&B();k.makeOverlayPositions=u;c.fn.cropzoom.updateOverlayPosition=function(a){k.makeOverlayPositions(a)};c.fn.cropzoom.getParameters=
function(a,b){var d=a.data("image"),e=a.data("selector");d={viewPortW:a.width(),viewPortH:a.height(),imageX:d.posX,imageY:d.posY,imageRotate:d.rotation,imageW:d.w,imageH:d.h,imageSource:d.source,selectorX:e.x,selectorY:e.y,selectorW:e.w,selectorH:e.h};return c.extend(d,b)};c.fn.cropzoom.getSelf=function(){return k};return this}else alert("You must include ui.draggable, ui.resizable and ui.slider to use cropZoom")})};c.fn.extend({setSelector:function(f,h,p,l,e){var r=c(this);r.data("selector",{x:f,
y:h,w:p,h:l});var t={position:{top:h,left:f}};void 0!=e&&1==e?r.find("#"+r[0].id+"_selector").animate({top:h,left:f,width:p,height:l},"slow",function(){r.data("options").selector.startWithOverlay&&r.cropzoom.updateOverlayPosition(t)}):(r.find("#"+r[0].id+"_selector").css({top:h,left:f,width:p,height:l}),c(this).data("options").selector.startWithOverlay&&r.cropzoom.updateOverlayPosition(t))},restore:function(){var f=c(this),h=f.data("options");f.empty();f.data("image",{});f.data("selector",{});""!=
h.expose.zoomElement&&c(h.expose.zoomElement).empty();""!=h.expose.rotationElement&&c(h.expose.rotationElement).empty();""!=h.expose.elementMovement&&c(h.expose.elementMovement).empty();f.cropzoom(h)},send:function(f,h,p,l){var e=c(this);c.ajax({url:f,type:h,data:e.cropzoom.getParameters(e,p),success:function(c){e.data("imageResult",c);void 0!==l&&null!=l&&l(c)}})}})})(jQuery);
(function(c){function f(c,f){if(!(1<c.originalEvent.touches.length)){c.preventDefault();var e=c.originalEvent.changedTouches[0],h=document.createEvent("MouseEvents");h.initMouseEvent(f,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null);c.target.dispatchEvent(h)}}c.support.touch="ontouchend"in document;if(c.support.touch){var h=c.ui.mouse.prototype,p=h._mouseInit,l;h._touchStart=function(c){!l&&this._mouseCapture(c.originalEvent.changedTouches[0])&&(l=!0,this._touchMoved=!1,
f(c,"mouseover"),f(c,"mousemove"),f(c,"mousedown"))};h._touchMove=function(c){l&&(this._touchMoved=!0,f(c,"mousemove"))};h._touchEnd=function(c){l&&(f(c,"mouseup"),f(c,"mouseout"),this._touchMoved||f(c,"click"),l=!1)};h._mouseInit=function(){this.element.bind("touchstart",c.proxy(this,"_touchStart")).bind("touchmove",c.proxy(this,"_touchMove")).bind("touchend",c.proxy(this,"_touchEnd"));p.call(this)}}})(jQuery);